import { PrismaClient } from '@prisma/client';
import fs from 'fs';
import path from 'path';
import { config } from 'dotenv';

// Carregar vari√°veis de ambiente
config({ path: '.env.local' });

const prisma = new PrismaClient();

interface ChangelogEntry {
  versao: string;
  dataLancamento: Date;
  tipo: 'ADICIONADO' | 'ALTERADO' | 'CORRIGIDO' | 'REMOVIDO' | 'DEPRECIADO' | 'SEGURANCA';
  titulo: string;
  descricao: string;
  categoria?: 'FUNCIONALIDADE' | 'INTERFACE' | 'PERFORMANCE' | 'SEGURANCA' | 'CONFIGURACAO' | 'DOCUMENTACAO' | 'TECNICO';
  prioridade: 'BAIXA' | 'MEDIA' | 'ALTA' | 'CRITICA';
  publicado: boolean;
  itens: {
    tipo: 'ADICIONADO' | 'ALTERADO' | 'CORRIGIDO' | 'REMOVIDO' | 'DEPRECIADO' | 'SEGURANCA';
    titulo: string;
    descricao: string;
    ordem: number;
  }[];
}

function parseChangelogMd(): ChangelogEntry[] {
  try {
    const changelogPath = path.join(process.cwd(), 'CHANGELOG.md');
    const content = fs.readFileSync(changelogPath, 'utf-8');
    
    const changelogs: ChangelogEntry[] = [];
    const lines = content.split('\n');
    
    let currentVersion: string | null = null;
    let currentDate: Date | null = null;
    let currentTitle = '';
    let currentDescription = '';
    let currentItems: {
      tipo: 'ADICIONADO' | 'ALTERADO' | 'CORRIGIDO' | 'REMOVIDO' | 'DEPRECIADO' | 'SEGURANCA';
      titulo: string;
      descricao: string;
      ordem: number;
    }[] = [];
    let currentSection = '';
    let itemOrder = 1;
    
    for (let i = 0; i < lines.length; i++) {
      const line = lines[i]?.trim() || '';
      
      // Detectar vers√£o (ex: ## [0.2.1] - 2025-01-14)
      const versionMatch = line.match(/^##\s*\[([^\]]+)\]\s*-\s*(.+)$/);
      if (versionMatch && versionMatch[1] && versionMatch[2]) {
        // Salvar vers√£o anterior se existir
        if (currentVersion && currentDate) {
          changelogs.push({
            versao: currentVersion,
            dataLancamento: currentDate,
            tipo: 'ADICIONADO',
            titulo: currentTitle || `Vers√£o ${currentVersion}`,
            descricao: currentDescription || `Mudan√ßas da vers√£o ${currentVersion}`,
            categoria: determineCategory(currentVersion),
            prioridade: determinePriority(currentVersion),
            publicado: true,
            itens: currentItems
          });
        }
        
        // Iniciar nova vers√£o
        currentVersion = versionMatch[1];
        currentDate = parseDate(versionMatch[2]);
        currentTitle = '';
        currentDescription = '';
        currentItems = [];
        currentSection = '';
        itemOrder = 1;
        continue;
      }
      
      // Pular vers√µes n√£o lan√ßadas
      if (line.includes('[N√£o Lan√ßado]') || line.includes('[Unreleased]')) {
        currentVersion = null;
        continue;
      }
      
      // Detectar se√ß√£o (ex: ### üîß Alterado)
      const sectionMatch = line.match(/^###\s*[üîß‚ú®üõ†Ô∏èüîÑüêõüóëÔ∏èüöÄüìöüìä‚úÖ]?\s*(.+)$/);
      if (sectionMatch && sectionMatch[1]) {
        currentSection = sectionMatch[1].trim();
        continue;
      }
      
      // Detectar item (ex: - **Nome do Item**: Descri√ß√£o)
      const itemMatch = line.match(/^-\s*\*\*([^*]+)\*\*:?\s*(.*)$/);
      if (itemMatch && itemMatch[1] && itemMatch[2] && currentVersion) {
        const titulo = itemMatch[1].trim();
        const descricao = itemMatch[2].trim();
        
        if (titulo && descricao) {
          currentItems.push({
            tipo: mapSectionToType(currentSection),
            titulo,
            descricao,
            ordem: itemOrder++
          });
        }
        continue;
      }
      
      // Detectar itens simples (ex: - Configura√ß√£o inicial do projeto Next.js 15)
      const simpleItemMatch = line.match(/^-\s*(.+)$/);
      if (simpleItemMatch && simpleItemMatch[1] && currentVersion && currentSection) {
        const texto = simpleItemMatch[1].trim();
        
        if (texto && !texto.startsWith('‚úÖ') && !texto.startsWith('üëë') && !texto.startsWith('üë®‚Äçüíº')) {
          currentItems.push({
            tipo: mapSectionToType(currentSection),
            titulo: texto.length > 50 ? texto.substring(0, 50) + '...' : texto,
            descricao: texto,
            ordem: itemOrder++
          });
        }
        continue;
      }
      
      // Capturar t√≠tulo e descri√ß√£o da vers√£o
      if (currentVersion && !currentTitle && line && !line.startsWith('#') && !line.startsWith('-')) {
        if (line.length > 10) {
          currentTitle = line.length > 100 ? line.substring(0, 100) + '...' : line;
          currentDescription = line;
        }
      }
    }
    
    // Salvar √∫ltima vers√£o
    if (currentVersion && currentDate) {
      changelogs.push({
        versao: currentVersion,
        dataLancamento: currentDate,
        tipo: 'ADICIONADO',
        titulo: currentTitle || `Vers√£o ${currentVersion}`,
        descricao: currentDescription || `Mudan√ßas da vers√£o ${currentVersion}`,
        categoria: determineCategory(currentVersion),
        prioridade: determinePriority(currentVersion),
        publicado: true,
        itens: currentItems
      });
    }
    
    return changelogs;
  } catch (error) {
    console.error('‚ùå Erro ao parsear CHANGELOG.md:', error);
    // Fallback para dados hardcoded se o parsing falhar
    const entries: ChangelogEntry[] = [];
  
  // Vers√£o 0.2.1
  entries.push({
    versao: '0.2.1',
    dataLancamento: new Date('2025-01-14'),
    tipo: 'ADICIONADO',
    titulo: 'Sistema de Changelog Autom√°tico e Versionamento',
    descricao: 'Implementa√ß√£o completa do sistema de changelog autom√°tico com gera√ß√£o de build info, interface web e API completa.',
    categoria: 'FUNCIONALIDADE',
    prioridade: 'ALTA',
    publicado: true,
    itens: [
      {
        tipo: 'ADICIONADO',
        titulo: 'Sistema de Changelog Autom√°tico',
        descricao: 'Cria√ß√£o autom√°tica de changelogs baseada em commits Git',
        ordem: 1
      },
      {
        tipo: 'ADICIONADO',
        titulo: 'Gera√ß√£o de Build Info',
        descricao: 'Script para capturar informa√ß√µes de build, Git e ambiente',
        ordem: 2
      },
      {
        tipo: 'ADICIONADO',
        titulo: 'Interface Web de Changelog',
        descricao: 'P√°gina p√∫blica para visualiza√ß√£o de changelogs com pagina√ß√£o',
        ordem: 3
      },
      {
        tipo: 'ADICIONADO',
        titulo: 'API de Changelog',
        descricao: 'Endpoints completos para CRUD de changelogs e itens',
        ordem: 4
      },
      {
        tipo: 'ADICIONADO',
        titulo: 'Suporte a Conventional Commits',
        descricao: 'Classifica√ß√£o autom√°tica de mudan√ßas por tipo',
        ordem: 5
      },
      {
        tipo: 'ADICIONADO',
        titulo: 'Versionamento Sem√¢ntico',
        descricao: 'Scripts para incremento autom√°tico de vers√µes',
        ordem: 6
      },
      {
        tipo: 'ADICIONADO',
        titulo: 'Documenta√ß√£o Completa',
        descricao: 'Guia detalhado do sistema de versionamento',
        ordem: 7
      },
      {
        tipo: 'ALTERADO',
        titulo: 'README.md',
        descricao: 'Adicionada se√ß√£o sobre sistema de versionamento e novos scripts',
        ordem: 8
      },
      {
        tipo: 'ALTERADO',
        titulo: 'package.json',
        descricao: 'Inclu√≠dos scripts para build:info, changelog e versionamento',
        ordem: 9
      },
      {
        tipo: 'ALTERADO',
        titulo: 'Esquema Prisma',
        descricao: 'Adicionadas tabelas Changelog e ChangelogItem com enums',
        ordem: 10
      }
    ]
  });
  
  // Vers√£o 0.2.0
  entries.push({
    versao: '0.2.0',
    dataLancamento: new Date('2025-01-13'),
    tipo: 'ADICIONADO',
    titulo: 'Sistema Completo de Gest√£o e Automa√ß√£o',
    descricao: 'Implementa√ß√£o completa do sistema com versionamento autom√°tico, CI/CD, Docker, Prisma ORM e migra√ß√£o do Supabase.',
    categoria: 'FUNCIONALIDADE',
    prioridade: 'CRITICA',
    publicado: true,
    itens: [
      {
        tipo: 'ADICIONADO',
        titulo: 'Sistema de Versionamento Autom√°tico',
        descricao: 'Scripts personalizados para build, changelog e tags Git',
        ordem: 1
      },
      {
        tipo: 'ADICIONADO',
        titulo: 'Pipeline CI/CD Completo',
        descricao: 'GitHub Actions com workflows de release autom√°tico',
        ordem: 2
      },
      {
        tipo: 'ADICIONADO',
        titulo: 'Configura√ß√£o Docker',
        descricao: 'docker-compose.yml para PostgreSQL e PgAdmin',
        ordem: 3
      },
      {
        tipo: 'ADICIONADO',
        titulo: 'Implementa√ß√£o Prisma ORM',
        descricao: 'Schema completo com modelos Usuario, Avaliacao e Feedback',
        ordem: 4
      },
      {
        tipo: 'ADICIONADO',
        titulo: 'Sistema de Relacionamentos',
        descricao: 'Hierarquia supervisor/atendente com enums tipados',
        ordem: 5
      },
      {
        tipo: 'ADICIONADO',
        titulo: 'Migra√ß√£o Completa do Supabase',
        descricao: 'Script automatizado para transferir todas as tabelas',
        ordem: 6
      },
      {
        tipo: 'ADICIONADO',
        titulo: 'P√°ginas do Sistema',
        descricao: 'Avalia√ß√µes, Feedbacks e Configura√ß√µes com layout consistente',
        ordem: 7
      },
      {
        tipo: 'ADICIONADO',
        titulo: 'Sistema de Autentica√ß√£o Robusto',
        descricao: 'NextAuth.js/Auth.js v5 com prote√ß√£o de rotas',
        ordem: 8
      },
      {
        tipo: 'ADICIONADO',
        titulo: 'Gerenciamento de Usu√°rios',
        descricao: 'CRUD completo com pagina√ß√£o, filtros e permiss√µes',
        ordem: 9
      },
      {
        tipo: 'ADICIONADO',
        titulo: 'Scripts de Desenvolvimento',
        descricao: 'Teste de conex√£o, seed autom√°tico e valida√ß√£o de dados',
        ordem: 10
      },
      {
        tipo: 'CORRIGIDO',
        titulo: 'Sistema de Permiss√µes',
        descricao: 'Inconsist√™ncias entre banco e c√≥digo resolvidas',
        ordem: 11
      },
      {
        tipo: 'CORRIGIDO',
        titulo: 'Autentica√ß√£o',
        descricao: 'Configura√ß√£o corrigida para tabela usuarios PostgreSQL',
        ordem: 12
      },
      {
        tipo: 'REMOVIDO',
        titulo: 'Depend√™ncia Supabase',
        descricao: 'Cliente e configura√ß√µes antigas removidas',
        ordem: 13
      }
    ]
  });
  
  // Vers√£o 0.1.0
  entries.push({
    versao: '0.1.0',
    dataLancamento: new Date('2024-12-18'),
    tipo: 'ADICIONADO',
    titulo: 'Configura√ß√£o Inicial do Projeto',
    descricao: 'Setup inicial do projeto Next.js 15 com TypeScript, autentica√ß√£o, Supabase e interface completa.',
    categoria: 'CONFIGURACAO',
    prioridade: 'CRITICA',
    publicado: true,
    itens: [
      {
        tipo: 'ADICIONADO',
        titulo: 'Configura√ß√£o inicial do projeto',
        descricao: 'Next.js 15 com TypeScript',
        ordem: 1
      },
      {
        tipo: 'ADICIONADO',
        titulo: 'Sistema de autentica√ß√£o',
        descricao: 'NextAuth.js v5 com prote√ß√£o de rotas',
        ordem: 2
      },
      {
        tipo: 'ADICIONADO',
        titulo: 'Integra√ß√£o com Supabase',
        descricao: 'Banco de dados PostgreSQL',
        ordem: 3
      },
      {
        tipo: 'ADICIONADO',
        titulo: 'Interface de usu√°rio',
        descricao: 'Tailwind CSS e shadcn/ui',
        ordem: 4
      },
      {
        tipo: 'ADICIONADO',
        titulo: 'P√°gina de login',
        descricao: 'Valida√ß√£o usando React Hook Form e Zod',
        ordem: 5
      },
      {
        tipo: 'ADICIONADO',
        titulo: 'Dashboard principal',
        descricao: 'Estat√≠sticas e gr√°ficos com Recharts',
        ordem: 6
      },
      {
        tipo: 'ADICIONADO',
        titulo: 'Sistema de roles',
        descricao: 'admin, supervisor, attendant',
        ordem: 7
      },
      {
        tipo: 'ADICIONADO',
        titulo: 'Middleware de prote√ß√£o',
        descricao: 'Prote√ß√£o de rotas baseada em autentica√ß√£o',
        ordem: 8
      },
      {
        tipo: 'ADICIONADO',
        titulo: 'Componentes de UI',
        descricao: 'Alert, Button, Card, Input, Table, Dialog',
        ordem: 9
      },
      {
        tipo: 'ADICIONADO',
        titulo: 'Estrutura de documenta√ß√£o',
        descricao: 'README, guias de desenvolvimento e API',
        ordem: 10
      }
    ]
  });
  
    return entries;
  }
}

// Fun√ß√£o auxiliar para mapear se√ß√£o para tipo
function mapSectionToType(section: string): 'ADICIONADO' | 'ALTERADO' | 'CORRIGIDO' | 'REMOVIDO' | 'DEPRECIADO' | 'SEGURANCA' {
  const sectionLower = section.toLowerCase();
  
  if (sectionLower.includes('adicionado') || sectionLower.includes('added')) {
    return 'ADICIONADO';
  }
  if (sectionLower.includes('alterado') || sectionLower.includes('changed') || sectionLower.includes('configura√ß√£o')) {
    return 'ALTERADO';
  }
  if (sectionLower.includes('corrigido') || sectionLower.includes('fixed')) {
    return 'CORRIGIDO';
  }
  if (sectionLower.includes('removido') || sectionLower.includes('removed')) {
    return 'REMOVIDO';
  }
  if (sectionLower.includes('descontinuado') || sectionLower.includes('deprecated')) {
    return 'DEPRECIADO';
  }
  if (sectionLower.includes('seguran√ßa') || sectionLower.includes('security')) {
    return 'SEGURANCA';
  }
  
  return 'ADICIONADO'; // padr√£o
}

// Fun√ß√£o auxiliar para determinar categoria
function determineCategory(version: string): 'FUNCIONALIDADE' | 'INTERFACE' | 'PERFORMANCE' | 'SEGURANCA' | 'CONFIGURACAO' | 'DOCUMENTACAO' | 'TECNICO' {
  const [major, minor] = version.split('.').map(Number);
  
  if (major === 0 && minor === 1) {
    return 'CONFIGURACAO';
  }
  if (major === 0 && minor === 2) {
    return 'FUNCIONALIDADE';
  }
  
  return 'TECNICO';
}

// Fun√ß√£o auxiliar para determinar prioridade
function determinePriority(version: string): 'BAIXA' | 'MEDIA' | 'ALTA' | 'CRITICA' {
  const [major, minor] = version.split('.').map(Number);
  
  if (major && major > 0) {
    return 'CRITICA';
  }
  if (minor === 1) {
    return 'CRITICA';
  }
  
  return 'ALTA';
}

// Fun√ß√£o auxiliar para parsear data
function parseDate(dateStr: string): Date {
  // Formato esperado: 2025-08-14 ou 2025-08-13
  const match = dateStr.match(/(\d{4})-(\d{2})-(\d{2})/);
  if (match && match[1] && match[2] && match[3]) {
    return new Date(parseInt(match[1]), parseInt(match[2]) - 1, parseInt(match[3]));
  }
  
  // Para pr√≥ximos changelogs, usar data atual do sistema
  return new Date();
}

async function populateChangelog() {
  try {
    console.log('üöÄ Iniciando popula√ß√£o da tabela de changelog...');
    
    // Limpar dados existentes
    console.log('üßπ Limpando dados existentes...');
    await prisma.changelogItem.deleteMany();
    await prisma.changelog.deleteMany();
    
    const entries = parseChangelogMd();
    
    console.log(`üìù Criando ${entries.length} entradas de changelog...`);
    
    for (const entry of entries) {
      console.log(`   üìã Criando changelog para vers√£o ${entry.versao}...`);
      
      const changelog = await prisma.changelog.create({
        data: {
          versao: entry.versao,
          dataLancamento: entry.dataLancamento,
          tipo: entry.tipo,
          titulo: entry.titulo,
          descricao: entry.descricao,
          categoria: entry.categoria,
          prioridade: entry.prioridade,
          publicado: entry.publicado
        }
      });
      
      console.log(`   üìù Criando ${entry.itens.length} itens para vers√£o ${entry.versao}...`);
      
      for (const item of entry.itens) {
        await prisma.changelogItem.create({
          data: {
            changelogId: changelog.id,
            tipo: item.tipo,
            titulo: item.titulo,
            descricao: item.descricao,
            ordem: item.ordem
          }
        });
      }
    }
    
    console.log('‚úÖ Changelog populado com sucesso!');
    
    // Verificar dados criados
    const totalChangelogs = await prisma.changelog.count();
    const totalItens = await prisma.changelogItem.count();
    
    console.log(`üìä Estat√≠sticas:`);
    console.log(`   üìã Total de changelogs: ${totalChangelogs}`);
    console.log(`   üìù Total de itens: ${totalItens}`);
    
  } catch (error) {
    console.error('‚ùå Erro ao popular changelog:', error);
    throw error;
  } finally {
    await prisma.$disconnect();
  }
}

if (require.main === module) {
  populateChangelog()
    .then(() => {
      console.log('üéâ Script executado com sucesso!');
      process.exit(0);
    })
    .catch((error) => {
      console.error('üí• Erro na execu√ß√£o do script:', error);
      process.exit(1);
    });
}

export { populateChangelog };